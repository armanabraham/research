---
title: "Table of contents"
author: ''
date: ''
output:
  html_document:
    highlight: kate
    theme: spacelab
    toc: yes
---

### Description
Reproducing data analysis and figures reported in "Low intensity TMS enhances perception of visual stimuli" by Arman Abrahamyan, Colin Clifford, Ehsan Arabzadeh and Justin Harris. 

```{r echo=FALSE, message=FALSE}
library(plyr)
library(ggplot2)
library(ggthemes)
library(gridExtra)
library(pastecs) # For stat.desc
library(afex)
library(nlme) # For linear mixed-effects modelling, lme
## Load Winston Chan's function to compute within-subjects error bars
source('WithinSbj_StdErrors.R')

# Load Exp 1 and 2 data 
load("Exp1_Exp2_github.RData")
# Order Conditions for plotting convenience
exp1_dataMean$Condition <- factor(exp1_dataMean$Condition, levels=c("NoTMS", "ip80", "ip90", "60", "70", "80", "90", "100"))
```
### Data
Individual subject data for both Exp 1 and 2 are saved as exp1\_dataMean and exp2\_dataMean, respectively. These are data frames. 

```{r echo=TRUE, message=FALSE}
head(exp1_dataMean, 4)
head(exp2_dataMean, 4)
```


### Data analysis of Experiment 1
#### Trend analysis 
Here we test if visual sensitivity changes as a function of TMS stimulation intensity. Due to repeated-measures design, we conducted mixed-modelling analysis wherein subject was a random effect and TMS stimulation intensity was fixed effect. We fitted linear, cubic and quadratic models to the data and found that quadratic trend explains data better than linear or cubic fits (𝜒2(1)=5.22, p=0.022). 
```{r, echo=FALSE}
################## --- Data analysis of Experiment 1 --- ###################
# Order Conditions for plotting convenience
#exp1_dataMean$Condition <- factor(exp1_dataMean$Condition, levels=c("NoTMS", "ip80", "ip90", "60", "70", "80", "90", "100"))

# Find out if there is a quadratic trend in the data as a function of TMS intensity
# Select only experimental conditions (exclude NoTMS and ipsilatoral stimulation)
exp1_quadraticFitData <- droplevels(subset(exp1_dataMean, !(Condition %in% c("ip80", "ip90", "NoTMS"))))
exp1_quadraticFitData <- within(exp1_quadraticFitData, {CondAsNum <- as.numeric(as.character(Condition)) })
baseline <- lme(data=exp1_quadraticFitData, Sensitivity~1, random=~1|PPT/CondAsNum, method="ML")
linear <- update(baseline, .~. + CondAsNum)
quadratic <- update(baseline, .~. + CondAsNum + I(CondAsNum^2))
cubic <- update(baseline, .~. + CondAsNum + I(CondAsNum^2)+ I(CondAsNum^3))
anova(baseline, linear, quadratic, cubic)

```


#### Plotting change in visual sensitivity as a function of TMS intensity, and control conditions
This plot corresponds to Figure 1A in manuscript. 

```{r, echo=FALSE}
# Compute high-res quadratic trend for the plot
# Summarise data for plotting
fitX <- data.frame(CondAsNum=seq(60,100, 0.1))
predVals <- data.frame(x=fitX$CondAsNum, y=predict(quadratic, fitX, level=0))
# Plot sensitivity from Exp 1 together with quadratic trend
# Summarise data for plotting
exp1_dataForPlot <- droplevels(subset(exp1_dataMean, Condition!="NoTMS"))
exp1_dataForPlot$CoilPosition <- "Expt"
exp1_dataForPlot$CoilPosition[exp1_dataForPlot$Condition %in% c("ip80", "ip90")] <- "Cntr"
exp1_dataForPlot$CoilPosition <- as.factor(exp1_dataForPlot$CoilPosition)
## Change the name of the column called "Condition" into "Intensity" cause it is more intuitive
colnames(exp1_dataForPlot)[which(names(exp1_dataForPlot) == "Condition")] <- "Intensity"
## Now change ip80 and ip90 into 80 and 90
exp1_dataForPlot$Intensity <- mapvalues(exp1_dataForPlot$Intensity, from = c("ip80", "ip90"), to = c("80", "90"))
## Change order of columns (not sure if this is needed, but looks clearer)
exp1_dataForPlot <- droplevels(exp1_dataForPlot[,c("PPT", "CoilPosition", "Intensity", "Th", "Sensitivity")])

exp1_qFitForPlot <- summarySEwithin(exp1_dataForPlot, measurevar="Sensitivity", withinvars=c("Intensity", "CoilPosition"), idvar="PPT")
gExp1_SensTrend <- ggplot(exp1_qFitForPlot, aes(x=as.numeric(as.character(Intensity)), y=Sensitivity, color=CoilPosition)) + 
  theme_few() + 
  geom_rangeframe(color="grey30") + 
  theme(legend.position="none") + 
  xlab("Stimulation intensity\n (% phosphene threshold)") + 
  ylab("Contrast sensitivity") + 
  #theme(plot.background = element_rect(fill = "transparent",colour = NA)) + 
  #theme(panel.background = element_rect(fill = "transparent",colour = NA)) + 
  #theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border=element_blank()) + 
  #theme(panel.grid=element_blank(), panel.border=element_blank()) +
  #theme(axis.line = element_line(colour="grey30", size=0.3)) +
  #theme(axis.title.x = element_text(vjust=-0.3), axis.title.y = element_text(vjust=0.3)) + 
  geom_line(data=predVals, aes(x=x, y=y), linetype="dashed", colour="grey70", size=.3) +
  geom_line(subset=.(CoilPosition=="Expt"), aes(group=1), color="grey50", size=1) + 
  geom_errorbar(aes(ymin = Sensitivity - se, ymax = Sensitivity + se), width = 0.00, size = 0.2, color="grey50") +   # Change "se" to "ci" to plot 95% conf intervals
  geom_point(size=7, color="white") +
  geom_point(aes(shape=CoilPosition), size=4, color="grey20") + 
  scale_shape_manual(values=c(1,19,2), name="Coil\nposition")

print(gExp1_SensTrend)
```


