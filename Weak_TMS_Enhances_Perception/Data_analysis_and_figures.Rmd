---
title: "Table of contents"
author: ''
date: ''
output:
  html_document:
    highlight: kate
    theme: spacelab
    toc: yes
---

### Description
Reproducing data analysis and figures reported in "Low intensity TMS enhances perception of visual stimuli" by Arman Abrahamyan, Colin Clifford, Ehsan Arabzadeh and Justin Harris. You can download all these files, load the project into RStudio and reproduce the analysis by running Data\_analysis\_and_figures.Rmd file. 


Data are provided in RData (Exp1\_Exp2\_github.RData) and Excel (Exp1_Exp2_github.xslx) formats. 

```{r echo=FALSE, message=FALSE}
library(plyr)
library(ggplot2)
library(ggthemes)
library(gridExtra)
library(effsize) # for cohen.d
library(pastecs) # For stat.desc
library(afex)
library(nlme) # For linear mixed-effects modelling, lme
## Load Winston Chan's function to compute within-subjects error bars
source('WithinSbj_StdErrors.R')

# Load Exp 1 and 2 data 
load("Exp1_Exp2_github.RData")
# Order Conditions for plotting convenience
exp1_dataMean$Condition <- factor(exp1_dataMean$Condition, levels=c("NoTMS", "ip80", "ip90", "60", "70", "80", "90", "100"))
```
### Data
Individual subject data for both Exp 1 and 2 are saved as exp1\_dataMean and exp2\_dataMean, respectively. These are data frames. 

```{r echo=TRUE, message=FALSE}
head(exp1_dataMean, 4)
head(exp2_dataMean, 4)
```


### Data analysis of Experiment 1 (coarse orientation discrimination)
#### Quadratic trend in data 
Here we test if visual sensitivity changes as a function of TMS stimulation intensity. Due to repeated-measures design, we conducted mixed-modelling analysis wherein subject was a random effect and TMS stimulation intensity was fixed effect. We fitted linear, cubic and quadratic models to the data and found that quadratic fit explains data better than linear or cubic fits ($\chi^2$(1)=5.22, *p*=0.022).

```{r, echo=FALSE}
################## --- Data analysis of Experiment 1 --- ###################
# Order Conditions for plotting convenience
exp1_dataMean$Condition <- factor(exp1_dataMean$Condition, levels=c("NoTMS", "ip80", "ip90", "60", "70", "80", "90", "100"))

# Find out if there is a quadratic trend in the data as a function of TMS intensity
# Select only experimental conditions (exclude NoTMS and ipsilatoral stimulation)
exp1_quadraticFitData <- droplevels(subset(exp1_dataMean, !(Condition %in% c("ip80", "ip90", "NoTMS"))))
exp1_quadraticFitData <- within(exp1_quadraticFitData, {CondAsNum <- as.numeric(as.character(Condition)) })
baseline <- lme(data=exp1_quadraticFitData, Sensitivity~1, random=~1|PPT/CondAsNum, method="ML")
linear <- update(baseline, .~. + CondAsNum)
quadratic <- update(baseline, .~. + CondAsNum + I(CondAsNum^2))
cubic <- update(baseline, .~. + CondAsNum + I(CondAsNum^2)+ I(CondAsNum^3))

```

```{r}
anova(baseline, linear, quadratic, cubic)
```

#### Plot average data (Figure 1A) 
This corresponds to Figure 1A in the manuscript. The dashed line shows quadratic trend in the data. 

```{r, echo=FALSE, fig.width=5.7, fig.height=4.5, dev='pdf'}
# Compute high-res quadratic trend for the plot
# Summarise data for plotting
fitX <- data.frame(CondAsNum=seq(60,100, 0.1))
predVals <- data.frame(x=fitX$CondAsNum, y=predict(quadratic, fitX, level=0))
# Plot sensitivity from Exp 1 together with quadratic trend
# Summarise data for plotting
exp1_dataForPlot <- droplevels(subset(exp1_dataMean, Condition!="NoTMS"))
exp1_dataForPlot$CoilPosition <- "Expt"
exp1_dataForPlot$CoilPosition[exp1_dataForPlot$Condition %in% c("ip80", "ip90")] <- "Cntr"
exp1_dataForPlot$CoilPosition <- as.factor(exp1_dataForPlot$CoilPosition)
## Change the name of the column called "Condition" into "Intensity" cause it is more intuitive
colnames(exp1_dataForPlot)[which(names(exp1_dataForPlot) == "Condition")] <- "Intensity"
## Now change ip80 and ip90 into 80 and 90
exp1_dataForPlot$Intensity <- mapvalues(exp1_dataForPlot$Intensity, from = c("ip80", "ip90"), to = c("80", "90"))
## Change order of columns (not sure if this is needed, but looks clearer)
exp1_dataForPlot <- droplevels(exp1_dataForPlot[,c("PPT", "CoilPosition", "Intensity", "Th", "Sensitivity")])

exp1_qFitForPlot <- summarySEwithin(exp1_dataForPlot, measurevar="Sensitivity", withinvars=c("Intensity", "CoilPosition"), idvar="PPT")
gExp1_SensTrend <- ggplot(exp1_qFitForPlot, aes(x=as.numeric(as.character(Intensity)), y=Sensitivity, color=CoilPosition)) + 
  theme_few() + 
  theme(legend.position=c(0.19,0.87)) + 
  xlab("Stimulation intensity\n (% phosphene threshold)") + 
  ylab("Contrast sensitivity") + 
  geom_line(data=predVals, aes(x=x, y=y), linetype="dashed", colour="grey70", size=.3) +
  geom_line(subset=.(CoilPosition=="Expt"), aes(group=1), color="grey50", size=1) + 
  geom_errorbar(aes(ymin = Sensitivity - se, ymax = Sensitivity + se), width = 0.00, size = 0.2, color="grey50") +   # Change "se" to "ci" to plot 95% conf intervals
  geom_point(size=7, color="white") +
  geom_point(aes(shape=CoilPosition), size=4, color="grey20") + 
  scale_shape_manual(values=c(1,19), name="Coil position", labels=c("Control (Ipsi)","Experimental (Contra)"))

print(gExp1_SensTrend)
```

#### Enhancement in visual sensitivity
To confirm enhancement in visual sensitivity, here we compare experimental (contralateral) stimulation with control (ipsilateral) stimulation. Because ipsilateral control condition was only tested at two TMS intensities (80 and 90% of PT), we performed a 2x2 repeated measures ANOVA comparing the location of the TMS coil (experimental vs control) and stimulation intensities (80 and 90%). 

```{r, echo=FALSE}
# Compute 2x2 ANOVA comparing 80% and 90% ipsi and contra conditions
exp1_data8090 <- droplevels(subset(exp1_dataForPlot,  Intensity %in% c("80", "90")))
aov8090 <- aov.car(data=exp1_data8090, Sensitivity~CoilPosition*Intensity+Error(PPT/(CoilPosition*Intensity)), return="Anova", args.return=list(es="pes"))
nice.anova(aov8090, es="pes")
```

This analysis confirmed that there was a significant main effect for the location of the TMS coil (*F*(1,10)=33.45, *p*<0.001, partial $\eta^2$=0.77). However, the main effect of stimulation intensity was not significant, indicating no difference between 80 and 90% intensities (*F*(1,10)=0.10, *p*=0.76, partial $\eta^2$=0.009). Further, there was no interaction between TMS location and stimulation intensity (*F*(1,10)=0.50, *p*=0.49, partial $\eta^2$=0.05).

We followed up with paired t-tests, which showed significant differences between experimental and control conditions at both 80% and 90% stimulation (80%: *Mdiff* =1.24, *t*(10)=2.65, *p*=0.02, Cohen’s *d*=0.27; 90%: *Mdiff* =1.80, *t*(10)=3.80, *p*=0.003, Cohen’s *d*=0.47).

80% contra vs ipsi
```{r, echo=FALSE}
# t-tests
# Compare 80% experimental and control conditions for sensitivity
exp1_data80 <- droplevels(subset(exp1_data8090, Intensity=="80"))
t.test(Sensitivity~CoilPosition, data=exp1_data80, paired=TRUE)
# Cohen's d
cohen.d(data=exp1_data80, Sensitivity~CoilPosition)
```

90% contra vs ipsi
```{r, echo=FALSE}
# 90% experimental vs control 
exp1_data90 <- droplevels(subset(exp1_data8090, Intensity=="90"))
t.test(Sensitivity~CoilPosition, data=exp1_data90, paired=TRUE)
cohen.d(data=exp1_data90, Sensitivity~CoilPosition)
```

#### Plot individual data
Same as the above but plotted by subject. For clarity, y-axis is scaled individually. 

```{r, echo=FALSE, fig.width=10, fig.height=7, dev='pdf'}
exp1_dataForPlot$Intensity <- factor(exp1_dataForPlot$Intensity, levels=c("60", "70", "80", "90", "100"))
ggplot(exp1_dataForPlot, aes(x=Intensity, y=Sensitivity, shape=CoilPosition)) + 
  theme_few() + 
  theme(legend.position=c(0.87,0.2)) + 
  xlab("Stimulation intensity\n (% phosphene threshold)") + 
  ylab("Contrast sensitivity") + 
  geom_line(aes(group=CoilPosition), color="grey50") + 
  geom_blank() + 
  scale_color_brewer(palette="Spectral") +
  facet_wrap(~PPT, scales="free") + 
  geom_point(size=5, color="white", shape=19) +
  geom_point(size=2.5, color="grey20") + 
  scale_y_continuous(expand = c(0.1, 0.1)) + 
  scale_shape_manual(values=c(1,19), name="Coil position", labels=c("Control (Ipsi)","Experimental (Contra)"))

```
